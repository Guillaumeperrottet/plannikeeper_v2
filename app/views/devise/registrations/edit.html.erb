<section class="vh-100" style="background-color: #f4f5f7;">
  <div class="container py-5 h-100">
    <div class="row d-flex justify-content-center align-items-center h-100">
      <div class="col col-lg-6 mb-4 mb-lg-0">
        <div class="card mb-3" style="border-radius: .5rem;">
          <div class="row g-0">
            <div class="col-md-4 gradient-custom text-center text-white"
              style="border-top-left-radius: .5rem; border-bottom-left-radius: .5rem;">
              <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava1-bg.webp"
                alt="Avatar" class="img-fluid my-5" style="width: 80px;" />
                <div class="mb-3 px-3">
                <label for="user_name" class="form-label text-white">Nom</label>
                <input type="text" id="user_name" class="form-control text-center" value="<%= current_user.name %>"
                  data-url="<%= registration_path(current_user) %>" />
                </div>
            </div>
            <div class="col-md-8">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                    <h6>Information</h6>
                    <%= link_to request.referrer || root_path, class: "text-dark" do %>
                      <i class="fa-solid fa-xmark"></i>
                    <% end %>
                    </div>
                  <hr class="mt-0 mb-4">
                  <div class="row pt-1">
                    <div class="mb-3">
                    <label for="user_mail" class="form-label text-black">Email</label>
                    <input type="text" id="user_mail" class="form-control text-center" value="<%= current_user.email %>"
                      data-url="<%= registration_path(current_user) %>"/>
                    </div>
                    <div class="col-6 mb-3">
                    <h6>Rôle</h6>
                    <p class="text-muted">
                      <% if current_user.role == 'private' %>
                      Privé
                      <% elsif current_user.role == 'admin' %>
                      Admin
                      <% else %>
                      User
                      <% end %>
                    </p>
                    </div>
                  </div>
                  <h6>Projects</h6>
                  <hr class="mt-0 mb-4">
                  <div class="row pt-1">
                    <% recent_projects = current_user.objets.order(created_at: :desc).limit(2) %>
                    <% if recent_projects.any? %>
                    <% recent_projects.each do |project| %>
                      <div class="col-6 mb-3">
                      <p class="text-muted"><%= project.id %></p>
                      </div>
                    <% end %>
                    <% else %>
                    <div class="col-12 mb-3">
                      <p class="text-muted">Aucun projet récent.</p>
                    </div>
                    <% end %>
                  </div>
                      <div class="d-flex justify-content-between align-items-center">
                        <button
                          id="delete-account-btn"
                          class="btn btn-outline-danger --danger"
                          data-controller="delete-confirm"
                          data-action="click->delete-confirm#confirm"
                          data-delete-confirm-url-value="<%= registration_path(current_user) %>"
                          data-delete-confirm-message-value="Êtes-vous sûr de vouloir supprimer votre compte ? Cette action est irréversible."
                        >
                          Supprimer mon compte
                        </button>
                      </div>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const nameField = document.getElementById("user_name");

    if (nameField) {
      nameField.addEventListener("blur", () => {
        const url = nameField.dataset.url;
        const token = document.querySelector('meta[name="csrf-token"]').content;

        fetch(url, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": token
          },
          body: JSON.stringify({ user: { name: nameField.value } })
        })
        .then(response => {
          if (!response.ok) {
            console.error("Erreur lors de la mise à jour du nom.");
          }
        })
        .catch(error => console.error("Erreur réseau :", error));
      });
    }
  });
</script>
